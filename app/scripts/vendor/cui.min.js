/* 07-11-2016 */
!function(){"use strict";cui.INFO={version:"2.2.0"},cui.supportsLocalStorage=function(){var a="testlocal";try{return localStorage.setItem(a,a),localStorage.removeItem(a),!0}catch(b){return!1}},cui.supportsBeforeunload=function(){return!(!cui.supportsLocalStorage()||"yes"!==localStorage.getItem(e))},cui.getRandomInt=function(a,b){return Math.floor(Math.random()*(b-a+1))+a};var a=function(){},b=window.console=window.console||{};Function.prototype.bind?cui.log=Function.prototype.bind.call(b.log,b):cui.log=function(){Function.prototype.apply.call(b.log,b,arguments)};var c=cui.log;if(cui.enableLog=function(){cui.log=c},cui.disableLog=function(){cui.log=a},cui.disableLog(),cui.supportsLocalStorage()){var d=localStorage.getItem("cui.log");d&&cui.enableLog()}var e="cui.supportsBeforeunload";cui.supportsLocalStorage()&&!localStorage.getItem(e)&&($(window).on("beforeunload",function(){localStorage.setItem(e,"yes")}),$(window).on("unload",function(){localStorage.getItem(e)||localStorage.setItem(e,"no")}));var f=!1;$(window).on("beforeunload",function(){f=!0}),cui.parseError=function(a){var b=a.statusText;return b.length||(b=$.parseJSON(a.responseText)),b},cui.ajax=function(a){var b=a.url||"",c=a.async!==!1,d=a.type||"GET",e=a.beforeSend||null,g=a.xhrFields||null,h=a.accepts||"",i=a.contentType||"",j=a.dataType||"json",k=a.data||null,l=a.dataFilter||null,m=a.converters||{},n=a.complete||null,o=a.error||null,p=a.success||null;return b.length?(cui.log("cui.ajax sending",b,d,h,i,a),$.ajax({url:b,type:d,async:c,xhrFields:g,beforeSend:e,accepts:{text:h,json:h},data:k,contentType:i,dataType:j,dataFilter:l,converters:m,error:o,complete:n,success:p}).then(null,function(a,b,c){if(""===a.responseText){cui.log("cui.ajax.then(fail):resolve()");var d=[];return $.Deferred().resolve(d,b,a)}return cui.log("cui.ajax.then(fail):reject()",a),$.Deferred().reject(a,b,c)}).done(function(a,b,c){cui.log("cui.ajax.done:",a,b,c),$.isFunction(p)&&p(a,b,c)}).fail(function(a,b,c){function d(){cui.log("cui.ajax.fail: status="+b+" : err="+c+" : xhr="+a.responseText)}cui.supportsBeforeunload()?f||d():setTimeout(function(){d()},1e3)})):void 0},cui.API_URLS=[{name:"PRD",url:"https://api.us1.covisint.com"},{name:"QA",url:"https://apiqa.np.covapp.io"},{name:"STG",url:"https://apistg.np.covapp.io"},{name:"PRDBLUE",url:"https://apidev.covapp.io"},{name:"STGBLUE",url:"https://apistgdev.np.covapp.io"}],cui.AUTH_CALLS=[{cmd:"_O1",cmdType:"popup",call:"/oauth/v3/authorization?client_id={clientId}&response_type={responseType}&scope={scope}&state={state}",type:"GET"},{cmd:"_O2",cmdType:"tokeninit",call:"/oauth/v3/token",type:"POST",contentType:"application/x-www-form-urlencoded"},{cmd:"_N1",cmdType:"solutioninfo",call:"/solution/v2/instances",type:"GET",contentType:"application/x-www-form-urlencoded"},{cmd:"_N2",cmdType:"popup",hostType:"login",call:"/CommonReg/secured?cmd=JWTAUTHENTICATE&SPA_URI={authRedirect}",type:"GET"},{cmd:"_N3",cmdType:"redirect",hostType:"login",call:"/CommonReg/secured?cmd=JWTAUTHENTICATE&SPA_URI={authRedirect}",type:"GET"},{cmd:"_N4",cmdType:"redirect",hostType:"logout",call:"/logout.do",type:"GET",contentType:"application/x-www-form-urlencoded"},{cmd:"_N5",call:"/authn/v4/token/tasks/invalidate",type:"GET",accepts:"application/vnd.com.covisint.platform.token.v1+json"}],cui.api=function(a){return g(a)},cui.apiSync=function(a){return g(a,"sync")},cui.apiAsync=function(a){return g(a)};var g=function(a,b){function c(a,b){va=cui.API_URLS,e(a.serviceUrl||""),wa=b,_.each(a.defs,function(a){_.isString(a)||_.each(a,function(a){var b=a.cmd&&a.call&&a.accepts;if(b){var c=_.find(wa,{cmd:a.cmd});if(c){var d=_.indexOf(wa,c);wa.splice(d,1,a)}else wa.push(a)}else cui.log("could not load dataCall",JSON.stringify(a))})});var c=/{(.*?)}/g;_.each(wa,function(a){d(a.cmd);var b=a.call.match(c);_.each(b,function(a){var b=a,c=b.replace("{","").replace("}",""),d=b,e=_.find(Da,{name:c});e?e.regex=d:Da.push({regex:d,name:c})})});var f=_.merge({},Ja,Ea);return f}function d(a){Ea[a]=function(b){return ta(a,b)}}function e(a){var b=_.result(_.find(va,{name:a}),"url");xa=b||a,cui.log("setServiceUrl",xa)}function f(){return xa}function g(a){return a&&a.responseJSON&&a.responseJSON.apiMessage?a.responseJSON.apiMessage:cui.parseError(a)}function h(a,b){function c(a){return++e>f.maxAttempts?(cui.log("searchFn maxed out."),a.resolve(b)):(cui.log("searchFn...",e),void cui.ajax(f).then(function(d){return d.length?(cui.log("searchFn resolved."),a.resolve(b)):(cui.log("searchFn unresolved."),void _.delay(c,f.delayDuration,a))}).fail(function(c){return cui.log("searchFn err",g(c)),a.resolve(b)}))}var d=$.Deferred(),e=0,f=_.cloneDeep(a);return f.data={},f.type="GET",f.qs=[["id",b.id]],f.url=ca(f.url,f),_.isUndefined(f.delayDuration)&&(f.delayDuration=100),_.isUndefined(f.maxAttempts)&&(f.maxAttempts=20),c(d),d}function i(){var a=Ia.length?Ia+".":"";return a}function j(a){var b=ya+"."+i()+a;return b}function k(){var a=window.localStorage.getItem(j("ot"));return a}function l(a){window.localStorage.setItem(j("ot"),a)}function m(){window.localStorage.removeItem(j("ot"))}function n(){var a=window.localStorage.getItem(j("xp"));return a}function o(a){window.localStorage.setItem(j("xp"),a)}function p(){window.localStorage.removeItem(j("xp"))}function q(){Aa=!1}function r(){Aa=!0}function s(a){var b=a>=0&&2147482648>=a;return b}function t(a,b,c){var d=1e3*a-3e4;s(d)?(clearInterval(ua),ua=setInterval(function(){Aa?cui.log("autoRefreshToken disabled."):c&&u(b)},d),cui.log("autoRefreshToken valid duration",d)):cui.log("autoRefreshToken disabled due to invalid duration",d)}function u(a){return a||(a={}),a.data={grant_type:"client_credentials",scope:"all"},O(),ta("_O2",a,!0).done(function(b){var c="access_token",d=b[c];if(d.length){m(),l(d),c="expires_in";var e=b[c];t(e,a,!0)}})}function v(){var a="",b="",c=window.location.search;return c.length||(c=window.location.hash),-1!==c.indexOf("access_token")?(a=c.match(/access_token=(.*)$/)[1].split("&state")[0],b=c.match(/expires_in=(.*)$/)[1]):-1!==c.indexOf("access_denied")&&(a="deny"),{token:a,expires:b}}function w(){var a=v(),b=decodeURIComponent(a.token),c=a.expires;b.length&&(m(),l(b),p(),o(c),window.close())}function x(a){function b(a,b){if(cui.log("waiting",a,b),b.closed!==!1){clearInterval(e);var c=k();if(c){if("deny"!==c){O();var d=n();return t(d,null,!1),a.resolve(c)}a.reject()}else a.reject()}}a.responseType="token",a.state=za,a.scope||(a.scope="all");var c=$.Deferred(),d=ta("_O1",a,!0),e=setInterval(function(){b(c,d)},500);return c}function y(){var a="",b="",c=window.location.search;return c.length||(c=window.location.hash),-1!==c.indexOf("xsrf")&&(a=c.match(/xsrfToken=(.*)$/)[1].split("&cuid")[0],b=c.match(/cuid=(.*)$/)[1]),cui.log("parseCovAuthInfoResponse",a,b,c,window.location),{token:a,cuid:b}}function z(a){a||(a={});var b=$.Deferred(),c=y(),d=decodeURIComponent(c.token),e=decodeURIComponent(c.cuid);if(d.length)if(N(d),Q(e),a.popup)cui.log("handleCovAuthResponse closing",a),window.close();else{if(a.selfRedirect)return cui.log("handleCovAuthResponse self redirect",B()),b.resolve(B());cui.log("handleCovAuthResponse redirect",V()),window.location.replace(V())}else if(d=M(),d&&d.length)return cui.log("handleCovAuthResponse resolved",B()),b.resolve(B());return b}function A(a){cui.log("setAuthInfo",a),T(a.solutionId);var b=_.cloneDeep(a);return delete b.solutionId,W(JSON.stringify(b)),$.Deferred().resolve(a)}function B(){var a={},b=X();return b&&b.length&&(a.authInfo=[],a.authInfo.push(JSON.parse(b))),a.cuid=P(),a.appRedirect=V(),a}function C(a){return a?(a.qs=[],a.qs.push([a.isIot?"iotSolutionHostname":"originUri",a.originUri||window.location.hostname])):(a={},a.qs=[],a.qs.push(["originUri",window.location.hostname])),cui.log("covAuthInfo",a),ta("_N1",a,!0).then(function(b){return a.qs=null,b.solutionId.length?(A(b),$.Deferred().resolve(b)):$.Deferred().reject(b)})}function D(a){return Ba?(cui.log("covAuthStarted"),$.Deferred().resolve()):(Ba=!0,C(a).then(function(b){return H(a)}))}function E(a){return a||(a={}),ta("_N5",a).then(function(a){return O(),R(),$.Deferred().resolve(a)})}function F(a){return E(a).then(function(b){return G(a)})}function G(a){var b=$.Deferred(),c=window.location.href.split("#")[0];return a||(a={}),a.qs=[],a.qs.push(["url",a.redirect||c]),cui.log("doCovLogout",a,a.qs[0]),a.popup?b:ta("_N4",a)}function H(a){var b=$.Deferred(),c=parseInt(Y()||0,0)+1;if(Z(c),cui.log("doCovAuth tries",Y()),m(),O(),R(),a.authRedirect=a.authRedirect||window.location.href,a.appRedirect=a.appRedirect||window.location.href,U(a.appRedirect),a.popup)var d=ta("_N2",a,!0),e=function(a,b){if(cui.log("waiting",a,b),b.closed!==!1){clearInterval(f);var c=M();if(c){var d=B();a.resolve(d)}else a.reject()}},f=setInterval(function(){e(b,d)},500);else ta("_N3",a,!0);return b}function I(){var a=M();return a&&a.length>0}function J(){var a=window.localStorage.getItem(j("n"));return a}function K(a){window.localStorage.setItem(j("n"),a)}function L(){window.localStorage.removeItem(j("n"))}function M(){var a=window.localStorage.getItem(j("xt"));return a}function N(a){window.localStorage.setItem(j("xt"),a)}function O(){window.localStorage.removeItem(j("xt"))}function P(){var a=window.localStorage.getItem(j("c"));return a}function Q(a){window.localStorage.setItem(j("c"),a)}function R(){window.localStorage.removeItem(j("c"))}function S(){var a=window.localStorage.getItem(j("sii"));return a}function T(a){window.localStorage.setItem(j("sii"),a)}function U(a){window.localStorage.setItem(j("r"),a)}function V(){return window.localStorage.getItem(j("r"))}function W(a){window.localStorage.setItem(j("ai"),a)}function X(){return window.localStorage.getItem(j("ai"))}function Y(){var a=window.localStorage.getItem(j("a"));return a}function Z(a){window.localStorage.setItem(j("a"),a)}function aa(){window.localStorage.removeItem(j("a"))}function ba(a){var b=_.find(wa,{cmd:a});return b}function ca(a,b){function c(a,b){var c=b[2]?encodeURIComponent(b[2]):"=",d=-1===a.indexOf("?")?"?":"&",e=d+encodeURIComponent(b[0])+c+encodeURIComponent(b[1]);return a+e}return b&&b.qs&&(_.isArray(b.qs[0])?_.each(b.qs,function(b){a=c(a,b)}):a=c(a,b.qs)),a}function da(a,b){return b&&_.each(Da,function(c){var d=b[c.name];if(!_.isUndefined(d)){var e=encodeURIComponent(d);a=a.replace(c.regex,e)}}),a}function ea(){var a="";if(Ca)a=f();else{var b=B();b&&b.authInfo&&(a="https://"+b.authInfo[0].identityUrl)}return a}function fa(){var a="";if(Ca)a=f();else{var b=B();b&&b.authInfo&&(a="https://"+b.authInfo[0].ssoUrl)}return a}function ga(a,b){var c="",d=ba(a);return d&&(c=_.cloneDeep(d),"login"===d.hostType?c.call=ea()+c.call:"logout"===d.hostType?c.call=fa()+c.call:c.call=f()+c.call,c.call=da(c.call,b),c.call=ca(c.call,b)),c}function ha(a,b){var c=!1;return a&&429===a.status?c=!0:a&&a.responseJSON&&a.responseJSON.fault&&a.responseJSON.fault.faultstring&&a.responseJSON.fault.faultstring.toLowerCase().indexOf("spike arrest")>-1?c=!0:ja(a,b)&&Ha&&(c=!0),c}function ia(a,b){var c=!1;return b&&401===b.status&&(c=!0),c}function ja(a,b){var c=!1;return b&&"unsecured"===b.cmdType&&a&&400===a.status&&"Solution-instance-Id is missing/invalid."===a.responseJSON.apiMessage&&(c=!0),c}function ka(a){var b=!1;return a&&(_.isUndefined(a.cmdType)||"unsecured"!==a.cmdType&&"solutioninfo"!==a.cmdType)&&(b=!0),b}function la(a){Fa=a}function ma(a){Ga=a}function na(){var a=Y()||0;return 1>a&&_.isFunction(Fa)?(cui.log("calling authHandler"),Fa()):(cui.log("bypassing authHandler tries=",a),aa(),oa())}function oa(){return _.isFunction(Ga)?(cui.log("calling authGiveUpHandler"),Ga()):(cui.log("bypassing authGiveUpHandler"),$.Deferred().reject())}function pa(a,b){return a.useCuid&&(a.url=a.url.replace(encodeURIComponent(a.personId),encodeURIComponent(P()))),_.isUndefined(a.delayForIndex)||a.delayForIndex!==!0?(b||(b=$.Deferred()),cui.ajax(a).then(function(c,d,e){var f=e.getResponseHeader("nonce");f?K(f):L(),ka(a)&&aa(),b.resolve(c)}).fail(function(c,d,e){return ha(c,a)?(cui.log("retrying",a.url),pa(a,b)):void(ia(a,c)?(cui.log("attempting to handle unauthorized"),na().then(function(c){return cui.log("authHandler success",c),sa(a),Ba=!1,pa(a,b)}).fail(function(a){b.reject(c,d,e)})):(ka(a)&&aa(),b.reject(c,d,e)))}),b.promise()):cui.ajax(a).then(function(b){return h(a,b)})}function qa(a,b){var c=400,d=650,e=200,f=200,g="Auth",h="toolbar=no, location=no, directories=no, status=no, menubar=no, copyhistory=no, ",i="width="+c+", height="+d+", top="+e+", left="+f,j=h+i;return window.open(a,g,j)}function ra(a,b){return window.location.href=a,window}function sa(a){if("jwtinit"===a.cmdType)a.xhrFields={withCredentials:!0};else if("solutioninfo"===a.cmdType);else if("unsecured"===a.cmdType)a.beforeSend=function(a,b){a.setRequestHeader("solutionInstanceId",S())};else if("nonce"===a.cmdType)a.beforeSend=function(a,b){a.setRequestHeader("nonce",J()),a.setRequestHeader("solutionInstanceId",S())};else if(I())a.xhrFields={withCredentials:!0},a.beforeSend=function(a,b){a.setRequestHeader("XSRFToken",M()),a.setRequestHeader("solutionInstanceId",S())};else{var b;if("tokeninit"===a.cmdType){var c=btoa(a.clientId+":"+a.clientSecret);b="Basic "+c}else{var d=decodeURIComponent(k());b="Bearer "+d}a.beforeSend=function(a,c){a.setRequestHeader("Authorization",b)}}return a}function ta(a,b,c){if(Ba&&!c)return cui.log("doCall covAuthStarted"),$.Deferred().resolve();b||(b={});var d,e=ga(a,b);return e&&(b.cmdType=e.cmdType,"popup"===b.cmdType?d=qa(e.call,b):"redirect"===b.cmdType?d=ra(e.call,b):(b.url=e.call,b.accepts=e.accepts,b.contentType=e.contentType,b.type=e.type,!b.data||"POST"!==b.type&&"PUT"!==b.type||"application/x-www-form-urlencoded"===b.contentType||(b.data=JSON.stringify(b.data)),b.delayForIndex=b.delayForIndex||e.delayForIndex,sa(b),d=pa(b))),d}a||(a={});var ua,va,wa,xa,ya="cui",za="cuijs",Aa=!1,Ba=!1,Ca=!1,Da=[],Ea={},Fa=null,Ga=null,Ha=a.retryUnsecured||!0,Ia=(a.sessionId||"")+"",Ja={version:function(){return cui.INFO.version},parseError:function(a){return g(a)},doCall:function(){return ta.apply(null,arguments)},getDataCalls:function(){return wa},setServiceUrl:function(a){return e(a)},getServiceUrl:function(){return f()},getXsrfToken:function(){return M()},getToken:function(){return k()},setToken:function(a){return l(a)},clearToken:function(){return m()},doSysAuth:function(a){return u(a)},doThreeLeggedOAuth:function(a){return x(a)},handleAuthResponse:function(){return w()},setAuthHandler:function(a){return la(a)},setAuthGiveUpHandler:function(a){return ma(a)},disableAutoRefresh:function(){return r()},enableAutoRefresh:function(){return q()},covAuth:function(a){return D(a)},handleCovAuthResponse:function(a){return z(a)},covAuthInfo:function(a){return C(a)},covLogout:function(a){return F(a)},setCovAuthInfo:function(a){return A(a)},getCovAuthInfo:function(a){return B(a)},doCovAuth:function(a){return H(a)}};if(a.defs||(a.defs=a.dataCallDefs),"sync"===b)return _.each(a.defs,function(a){_.isString(a)&&cui.log('WARNING. cui.js is in "sync" mode, so skipping load of def: ',a)}),c(a,cui.AUTH_CALLS);var Ka=cui.AUTH_CALLS,La=[],Ma=function(a,b){var c=$.Deferred();return cui.ajax(a).then(function(a){_.each(a,function(a){b.push(a)}),c.resolve()}).fail(function(){c.resolve()}),c};return _.each(a.defs,function(a){_.isString(a)&&La.push(Ma({url:a},Ka))}),$.when.apply($,La).then(function(){return cui.log("really got cui"),c(a,Ka)})}}(window.cui=window.cui||{});